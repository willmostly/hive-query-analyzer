insert overwrite table `${data_warehouse_db}`.`${wv_aggregate_table}` partition(cd) select watched_video.dw_p_id, watched_video.dw_d_id, watched_video.content_id, watched_video.subscription_status, watched_video.partner_access, watched_video.carrier_hs, watched_video.plan_type, watched_video.first_app_open_at, watched_video.third_party_referrer, watched_video.carrier, watched_video.playback_type, watched_video.is_premium, watched_video.stream_type, watched_video.network_type, watched_video.app_version, watched_video.x_variant_list, watched_video.language, watched_video.referrer_tray_name, watched_video.referrer_page_title, watched_video.wifi, watched_video.country, watched_video.state, watched_video.city, watched_video.platform, year(watched_video.tz_cd) as current_year, month(watched_video.tz_cd) as current_month, weekofyear(watched_video.tz_cd) as current_week, watched_video.watch_time_sum as watch_time, watched_video.buffer_time, watched_video.buffer_count, watched_video.seek_time, watched_video.rewind_count, watched_video.dw_device_id, watched_video.utm_campaign, watched_video.utm_source, watched_video.utm_term, watched_video.utm_medium, watched_video.referrer_logic, watched_video.referrer_theme_name, watched_video.referrer_source, watched_video.referrer_tray_id, watched_video.last_content_id, watched_video.model, watched_video.manufacturer, watched_video.asn_number, cms.genre as cms_genre, cms.contenttype as cms_content_type, cms.title as cms_title, cms.s_title as cms_sub_title, cms.channelname as cms_channel_name, cms.studioname as cms_studio_name, cms.showid as cms_show_id, cms.contentprovider as cms_content_provider_name, cms.seasonno as cms_season_number, cms.seasonname as cms_season_name, cms.episodeno as cms_episode_number, cms.content_category as cms_content_category, cms.tournamentid as cms_tournament_id, cms.tournament_name as cms_tournament_name, cms.sportsseasonid as cms_sports_season_id, cms.sportsseasonname as cms_sports_season_name, cms.match_id as cms_match_id, cms.avscontentid as cms_avs_content_id, cms.premium as cms_premium, cms.vip as cms_vip, cms.startdate as cms_start_date, cms.enddate as cms_end_date, watched_video.number_events, watched_video.min_ts, watched_video.max_ts, watched_video.login_method, watched_video.logged_in_status, watched_video.referrer, watched_video.page_referrer, watched_video.referrer_item_autoplayed, watched_video.play_type, watched_video.ab_experiment_list, watched_video.page_title, watched_video.captions_language, watched_video.host_name, watched_video.total_bytes_downloaded, watched_video.tz_cd as cd from ( (select dw_p_id, dw_d_id, dw_device_id, content_id, TO_DATE(FROM_UTC_TIMESTAMP(received_at, '${time_zone}')) as tz_cd, platform, country, state, city, subscription_status, carrier_hs, plan_type, first_app_open_at, partner_access, third_party_referrer, carrier, playback_type, is_premium, stream_type, network_type, app_version, x_variant_list, language, referrer_tray_name, referrer_page_title, wifi, utm_campaign, utm_source, utm_term, utm_medium, referrer_logic, referrer_theme_name, referrer_source, referrer_tray_id, last_content_id, model, manufacturer, asn_number, login_method, logged_in_status, referrer, page_referrer, referrer_item_autoplayed, play_type, ab_experiment_list, page_title, captions_language, host_name, sum(watch_time)/60 AS watch_time_sum, sum(buffer_time)/60 AS buffer_time, sum(buffer_count) AS buffer_count, sum(seek_time)/60 AS seek_time, sum(rewind_count) AS rewind_count, min(received_at) AS min_ts, max(received_at) AS max_ts, count(*) AS number_events, sum(bytes_downloaded) as total_bytes_downloaded  FROM `${data_lake_db}`.watched_video WHERE cd >= date_sub('${runDate}', '${number_days_before}') AND cd <= date_add('${runDate}', '${number_days_after}') AND TO_DATE(FROM_UTC_TIMESTAMP(received_at, '${time_zone}')) = '${runDate}' AND dw_p_id is NOT null AND cast(watch_time as double) < 100000.0 AND cast(watch_time as double) > 0.0 GROUP BY dw_p_id,dw_d_id,dw_device_id,content_id,TO_DATE(FROM_UTC_TIMESTAMP(received_at, '${time_zone}')),platform, country, state, city, subscription_status, carrier_hs, plan_type, first_app_open_at, partner_access, third_party_referrer, carrier, playback_type, is_premium, stream_type, network_type, app_version, x_variant_list, language, referrer_tray_name, referrer_page_title, wifi, utm_campaign, utm_source, utm_term, utm_medium, referrer_logic, referrer_theme_name, referrer_source, referrer_tray_id, last_content_id, model, manufacturer, asn_number, login_method, logged_in_status, referrer,page_referrer, referrer_item_autoplayed, play_type, ab_experiment_list, page_title, captions_language, host_name) watched_video left join `${cms_db}`.cms_playable_assets cms on watched_video.content_id = cms.contentid);